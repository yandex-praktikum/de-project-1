CREATE OR REPLACE VIEW analysis.orders (
order_id,
order_ts,
user_id,
bonus_payment,
payment,
cost,
bonus_grant,
status)
AS 
WITH a AS (SELECT order_id, dttm, status_id, 
ROW_NUMBER() OVER (PARTITION BY order_id ORDER BY dttm DESC) AS ranked
FROM production.orderstatuslog)
SELECT
o.order_id,
latest_s.dttm,
o.user_id,
o.bonus_payment,
o.payment,
o.cost,
o.bonus_grant,
latest_s.status_id
FROM production.orders o
JOIN (SELECT order_id, dttm, status_id 
FROM a
WHERE a.ranked = 1) AS latest_s ON latest_s.order_id = o.order_id
